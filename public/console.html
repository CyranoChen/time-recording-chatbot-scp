<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Time Recording Chatbot</title>
    <link rel="shortcut icon" href="/favicon">
    <link rel="stylesheet" href="resource/css/main.css">
</head>

<body class="skin-blue hold-transition sidebar-mini sidebar-collapse">
    <div class="wrapper">
        <header id="header" class="main-header"></header>
        <aside id="sidebar" class="main-sidebar sidebar-dark-primary elevation-4"></aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <section class="content-header">
                <h1>
                    Console
                    <small>Console of Time Recording</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li class="active">Console</li>
                </ol>
            </section>
            <!-- Main content -->
            <section class="content">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Main Features</h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form role="form">
                        <div class="box-body">
                            <div class="form-group col-sm-6">
                                <label for="tb-image">Face Recognition</label>
                                <input type="file" class="form-control" id="tb-image" placeholder="face uploader" />
                                <input type="hidden" class="form-control" id="tb-image-base64" />
                                <div class="form-group">
                                    <div class="col-sm-3 control-label" style="padding: 0">
                                        <img id="img-preview" for="tb-image" />
                                        <canvas id="cvs-image" class="hide"></canvas>
                                    </div>
                                    <div class="col-sm-9" style="padding: 0">
                                        <textarea id="ta-face-recognized" class="form-control" rows="8"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="tb-chat">SAP Conversational AI</label>
                                <input type="text" class="form-control" id="tb-chat" placeholder="say something">
                                <input type="hidden" class="form-control" id="tb-chat-session" />
                                <textarea id="ta-chat-responsed" class="form-control" rows="8"></textarea>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <div class="box-footer">
                            <div class="col-sm-6">
                                <button type="button" id="btn-recognize" class="btn btn-default">Recognize</button>
                                <button type="button" id="btn-label" class="btn btn-default">Generate Labels</button>
                                <button type="button" id="btn-entity" class="btn btn-default">Sync Entities</button>
                            </div>
                            <div class="col-sm-6">
                                <button type="button" id="btn-chat" class="btn btn-default">Chat</button>
                            </div>
                        </div>
                        <!-- /.box-footer -->
                    </form>
                </div>
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">ByDesign Instance</h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form role="form">
                        <div class="box-body">
                            <div class="form-group col-sm-6">
                                <label for="ta-employee-byd">Employee</label>
                                <textarea id="ta-employee-byd" class="form-control" rows="5"></textarea>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="ta-project-byd">Project</label>
                                <textarea id="ta-project-byd" class="form-control" rows="5"></textarea>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <div class="box-footer">
                            <div class="col-sm-6 btn-group">
                                <button type="button" id="btn-employee-byd" class="btn btn-default">Sync
                                    Employees</button>
                                <button type="button" id="btn-train-byd" class="btn btn-default">Train by Faces</button>
                            </div>
                            <div class="col-sm-6 btn-group">
                                <button type="button" id="btn-project-byd" class="btn btn-default">Sync
                                    Projects</button>
                                <button type="button" id="btn-task-byd" class="btn btn-default">Sync Tasks</button>
                                <button type="button" id="btn-service-byd" class="btn btn-default">Sync Services</button>
                                <button type="button" id="btn-record-byd" class="btn btn-default">Test</button>
                            </div>
                        </div>
                        <!-- /.box-footer -->
                    </form>
                </div>
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">BusinessOne Instance</h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form role="form">
                        <div class="box-body">
                            <div class="form-group col-sm-6">
                                <label for="ta-employee-b1">Employee</label>
                                <textarea id="ta-employee-b1" class="form-control" rows="5"></textarea>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="ta-project-b1">Project</label>
                                <textarea id="ta-project-b1" class="form-control" rows="5"></textarea>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <div class="box-footer">
                            <div class="col-sm-6 btn-group">
                                <button type="button" id="btn-employee-b1" class="btn btn-default">Sync
                                    Employees</button>
                                <button type="button" id="btn-train-b1" class="btn btn-default">Train by Faces</button>
                            </div>
                            <div class="col-sm-6 btn-group">
                                <button type="button" id="btn-project-b1" class="btn btn-default">Sync
                                    Projects</button>
                                <button type="button" id="btn-stage-b1" class="btn btn-default">Sync Stages</button>
                                <button type="button" id="btn-record-b1" class="btn btn-default">Test</button>
                            </div>
                        </div>
                        <!-- /.box-footer -->
                    </form>
                </div>
            </section>
        </div>

        <!-- Main Footer -->
        <footer id="footer" class="main-footer"></footer>
    </div>
    <!-- ./wrapper -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./resource/js/main.js"></script>
    <script type="text/javascript">
        $(function () {
            // load shared web parts
            $("#header").load("./shared/header.html");
            $("#footer").load("./shared/footer.html");

            $("#sidebar").load("./shared/sidebar.html", function () {
                $(".sidebar li.index-page").removeClass("active");
                $(".sidebar li.console-page").addClass("active");
            });

            var $tbImage = $("input#tb-image");
            var $tbImageBase64 = $("input#tb-image-base64");
            var $imgPreview = $("img#img-preview");
            var $taFaceRecognized = $("textarea#ta-face-recognized");
            var $btnRecognize = $("button#btn-recognize");
            var $btnLabel = $("button#btn-label");
            var $btnEntity = $("button#btn-entity");

            var $tbChat = $("input#tb-chat");
            var $tbChatSession = $("input#tb-chat-session");
            var $taChatResponsed = $("textarea#ta-chat-responsed");
            var $btnChat = $("button#btn-chat");

            var $taEmployeeByd = $("textarea#ta-employee-byd");
            var $btnEmployeeByd = $("button#btn-employee-byd");
            var $btnTrainByd = $("button#btn-train-byd");

            var $taProjectByd = $("textarea#ta-project-byd");
            var $btnProjectByd = $("button#btn-project-byd");
            var $btnTaskByd = $("button#btn-task-byd");
            var $btnServiceByd = $("button#btn-service-byd");
            var $btnRecordByd = $("button#btn-record-byd");

            var $taEmployeeB1 = $("textarea#ta-employee-b1");
            var $btnEmployeeB1 = $("button#btn-employee-b1");
            var $btnTrainB1 = $("button#btn-train-b1");

            var $taProjectB1 = $("textarea#ta-project-b1");
            var $btnProjectB1 = $("button#btn-project-b1");
            var $btnStageB1 = $("button#btn-stage-b1");
            var $btnRecordB1 = $("button#btn-record-b1");

            $tbImage.on('change', (e) => {
                if (typeof window.FileReader !== 'function') {
                    alert("The file API isn't supported on this browser yet.");
                    return;
                }

                let file = e.target.files[0];
                console.log(file);
                // $tbImageBase64.val('loading ...');
                $btnRecognize.hide();

                let fr = new FileReader();
                fr.onload = () => {
                    let img = new Image();
                    img.onload = () => {
                        let canvas = document.getElementById("cvs-image");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        let ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);

                        $tbImageBase64.val(canvas.toDataURL(file.type));
                        $btnRecognize.show();
                    };

                    img.src = fr.result;
                    $imgPreview.prop('src', img.src).css('max-width', '200px').css('max-height',
                        '168px');

                    // $tbFilename.val(file.name);
                };
                fr.readAsDataURL(file);
            });

            $tbChatSession.val(new Date().getTime());

            $tbChat.on('keydown', (e) => {
                if (e.which == 13) {
                    if ($tbChat.val() != '') {
                        $btnChat.click();
                    }
                    return false;
                }
            });

            $btnChat.click(() => {
                if ($tbChat.val() == '') {
                    alert("Please say something in chat box.")
                    return;
                }

                $btnChat.text('Submitting').prop('disable', false);
                const settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": "https://api.recast.ai/build/v1/dialog",
                    "method": "POST",
                    "headers": {
                        "Authorization": "Token aa50ad58c30e4a3e62d8cd88b73c0ba6",
                        "Content-Type": "application/json",
                        "cache-control": "no-cache",
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "message": {
                            "content": $tbChat.val(),
                            "type": "text"
                        },
                        "conversation_id": $tbChatSession.val()
                    })
                };

                $.ajax(settings).done((res) => {
                    console.log(res);
                    $taChatResponsed.val('');

                    if (res) {
                        $taChatResponsed.val(JSON.stringify(res, null, 2));
                    } else {
                        alert('error on chatting');
                    }

                    $btnChat.text(`Chat`).prop('disable', true);
                }).fail((res) => {
                    alert(`${res.status} (${res.statusText})`);
                });
            });

            $btnLabel.click(() => {
                $btnLabel.text('Labelling').prop('disable', false);
                $.post("/api/train", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $btnLabel.text(`Labelled (${Object.keys(d).length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });
            
            $btnEntity.click(() => {
                $btnEntity.text('Syncing').prop('disable', false);
                $.post("/api/sync", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $btnEntity.text(`Syncing (${Object.keys(d).length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnEmployeeB1.click(() => {
                $btnEmployeeB1.text('Syncing').prop('disable', false);
                $.post("/api/sync/b1/employee", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $taEmployeeB1.val(JSON.stringify(d, null, 2));
                        $btnEmployeeB1.text(`Synced Employees (${d.length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnTrainB1.click(() => {
                $btnTrainB1.text('Training').prop('disable', false);
                $.post("/api/train/b1", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $btnTrainB1.text(`Trained (${Object.keys(d).length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnProjectB1.click(() => {
                $btnProjectB1.text('Syncing').prop('disable', false);
                $.post("/api/sync/b1/project", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $taProjectB1.val(JSON.stringify(d, null, 2));
                        $btnProjectB1.text(`Synced Projects (${d.length})`).prop(
                            'disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnStageB1.click(() => {
                $btnStageB1.text('Syncing').prop('disable', false);
                $.post("/api/sync/b1/stage",
                    function (d, status) {
                        if (status === 'success' && d) {
                            console.log(d);
                            $taProjectB1.val(JSON.stringify(d, null, 2));
                            $btnStageB1.text(`Synced Stages (${d.length})`).prop(
                                'disable',
                                true);
                        } else {
                            alert(status);
                        }
                    });
            });

            $btnRecordB1.click(() => {
                $btnRecordB1.text('Recording').prop('disable', false);
                const settings = {
                    "async": true,
                    "crossDomain": false,
                    "url": "/api/sync/b1/record",
                    "method": "POST",
                    "headers": {
                        "Content-Type": "application/json",
                        "cache-control": "no-cache",
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "employee": "1",
                        "datetime": new Date().toLocaleDateString('zh-CN').split('/').join('-'), // yyyy-MM-dd
                        "startTime": "22:30",
                        "endTime": "23:30",
                        "project": "project",
                        "stage": "stage"
                    })
                };

                $.ajax(settings).done((res) => {
                    console.log(res);
                    $taProjectB1.val(JSON.stringify(res, null, 2));
                    if (res.DocNumber > 0) {
                        $btnRecordB1.text(
                            `Recorded (id: ${res.DocNumber})`
                        ).prop('disable', true);
                    }

                }).fail((res) => {
                    alert(`${res.status} (${res.statusText})`);
                });
            });

            $btnEmployeeByd.click(() => {
                $btnEmployeeByd.text('Syncing').prop('disable', false);
                $.post("/api/sync/byd/employee", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $taEmployeeByd.val(JSON.stringify(d, null, 2));
                        $btnEmployeeByd.text(`Synced Employees (${d.length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnTrainByd.click(() => {
                $btnTrainByd.text('Training').prop('disable', false);
                $.post("/api/train/byd", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $btnTrainByd.text(`Trained (${Object.keys(d).length})`).prop('disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnProjectByd.click(() => {
                $btnProjectByd.text('Syncing').prop('disable', false);
                $.post("/api/sync/byd/project?employee=E0202&status=true", function (d, status) {
                    if (status === 'success' && d) {
                        console.log(d);
                        $taProjectByd.val(JSON.stringify(d, null, 2));
                        $btnProjectByd.text(`Synced Projects (${d.length})`).prop(
                            'disable',
                            true);
                    } else {
                        alert(status);
                    }
                });
            });

            $btnTaskByd.click(() => {
                $btnTaskByd.text('Syncing').prop('disable', false);
                $.post("/api/sync/byd/task?project=Analyzer Implementation&employee=E0202&status=true",
                    function (d, status) {
                        if (status === 'success' && d) {
                            console.log(d);
                            $taProjectByd.val(JSON.stringify(d, null, 2));
                            $btnTaskByd.text(`Synced Tasks (${d.length})`).prop(
                                'disable',
                                true);
                        } else {
                            alert(status);
                        }
                    });
            });

            $btnServiceByd.click(() => {
                $btnServiceByd.text('Syncing').prop('disable', false);
                $.post("/api/sync/byd/service",
                    function (d, status) {
                        if (status === 'success' && d) {
                            console.log(d);
                            $taProjectByd.val(JSON.stringify(d, null, 2));
                            $btnServiceByd.text(`Synced Services (${d.length})`).prop(
                                'disable',
                                true);
                        } else {
                            alert(status);
                        }
                    });
            });

            $btnRecordByd.click(() => {
                $btnRecordByd.text('Recording').prop('disable', false);
                const settings = {
                    "async": true,
                    "crossDomain": false,
                    "url": "/api/sync/byd/record",
                    "method": "POST",
                    "headers": {
                        "Content-Type": "application/json",
                        "cache-control": "no-cache",
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "employee": "E0005",
                        "datetime": new Date().toLocaleDateString('zh-CN'),
                        "duration": "PT8H0M"
                    })
                };

                $.ajax(settings).done((res) => {
                    console.log(res);
                    $taProjectByd.val(JSON.stringify(res, null, 2));
                    if (res.d.results.LifeCycleStatusCode == 2) {
                        $btnRecordByd.text(
                            `Recorded (${res.d.results.LifeCycleStatusCodeText}) (${res.d.results.ApprovalStatusCodeText})`
                        ).prop('disable', true);
                    }

                }).fail((res) => {
                    alert(`${res.status} (${res.statusText})`);
                });
            });

            $btnRecognize.click(() => {
                var filename = $tbImage.val().split('\\').pop();
                var imageBase64 = $tbImageBase64.val();

                if (filename != '' && imageBase64 != '') {
                    $btnRecognize.text('Recognizing').prop('disabled', true);
                    const settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "/api/recognize",
                        "method": "POST",
                        "headers": {
                            "Content-Type": "application/json",
                            "cache-control": "no-cache",
                        },
                        "processData": false,
                        "data": JSON.stringify({
                            "filename": filename,
                            "image": imageBase64
                        })
                    };

                    $.ajax(settings).done((res) => {
                        console.log(res);
                        $taFaceRecognized.val('');

                        if (res && res.state === 'success' && res.data.length > 0) {
                            console.log(res);
                            $taFaceRecognized.val(JSON.stringify(res, null, 2));
                        } else {
                            alert('no smiliar item found')
                        }

                        $btnRecognize.text('Recognize').prop('disabled', false);
                    }).fail((res) => {
                        alert(`${res.status} (${res.statusText})`);
                    });
                } else {
                    alert('please upload the input image');
                }
            });
        });
    </script>
</body>

</html>