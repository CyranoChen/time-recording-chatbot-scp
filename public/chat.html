<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Tine Recording Chatbot</title>
    <link rel="shortcut icon" href="/favicon">
    <link rel="stylesheet" href="resource/css/main.css">
</head>

<body class="skin-blue hold-transition sidebar-mini sidebar-collapse">
    <div class="wrapper">
        <header id="header" class="main-header"></header>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Main content -->
            <section class="content">
                <div id="pnl-chat" class="box box-primary direct-chat direct-chat-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title"></h3>
                        <div class="box-tools pull-right">
                            <span data-toggle="tooltip" title="3 New Messages" class="badge bg-yellow hidden">3</span>
                            <button type="button" class="btn btn-box-tool"
                                onclick="window.location.href=window.location.href">
                                <i class="fa fa-refresh"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                    class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-box-tool" data-widget="remove"><i
                                    class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <!-- Conversations are loaded here -->
                        <div id="pnl-messages" class="direct-chat-messages">
                            <!-- Message. Default to the left -->
                        </div>
                        <!--/.direct-chat-messages-->
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <form role="form">
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <img id="img-me-avatar" class="direct-chat-img" />
                                </div>
                                <input type="text" name="tb-chat" id="tb-chat" placeholder="Type Message ..."
                                    class="form-control" style="height: 54px">
                                <input type="hidden" class="form-control" id="tb-chat-session" value="default" />
                                <span class="input-group-btn" style="padding: 5px">
                                    <button id="btn-chat" type="button" class="btn btn-primary btn-flat">
                                        <i class="fa fa-comments-o"></i></button>
                                </span>
                            </div>
                        </form>
                    </div>
                    <!-- /.box-footer-->
                </div>
                <!--/.direct-chat -->
            </section>
        </div>

        <!-- Main Footer -->
        <footer id="footer" class="main-footer"></footer>
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./resource/js/main.js"></script>

    <script type="text/javascript">
        $(function () {
            if (querystring('employee')) {
                // console.log(atob(querystring('employee')));
                var employee = JSON.parse(atob(querystring('employee')));
                if (employee) {
                    $("div#pnl-chat").find(".box-header h3.box-title").html(
                        `<img src="./resource/img/${employee.app}-logo.png" style="height: 32px" /> Direct Chat`
                    );
                    $("img#img-me-avatar").prop('src', employee.image).prop('alt', employee.name).attr('title',
                        `${employee.id},${employee.eid}`);
                } else {
                    window.location.href = '/';
                }
            } else {
                window.location.href = '/';
            }

            console.log(employee);

            // load shared web parts
            $("#header").load("./shared/header.html", (d, status) => {
                if (status === 'success' && d) {
                    $("#header").find("nav").hide();
                }
            });
            $("#footer").load("./shared/footer.html");

            function createChatItem(message, user = 'admin', avatar = './resource/img/chatbot-avatar.png',
                me = false) {
                return $("<div />", {
                        class: `direct-chat-msg ${me ? 'right' : 'left'}`
                    })
                    .append($("<div />", {
                        class: 'direct-chat-info clearfix'
                    }).append($("<span />", {
                        class: `direct-chat-name pull-${me ? 'right' : 'left'}`
                    }).text(user)).append($("<span />", {
                        class: `direct-chat-timestamp pull-${!me ? 'right' : 'left'}`
                    }).text(new Date().toLocaleString() // .toLocaleString('zh-CN', { hour12: false })
                    )))
                    .append($("<img />", {
                        class: "direct-chat-img",
                        src: avatar,
                        alt: user
                    }))
                    .append($("<div />", {
                        class: "direct-chat-text"
                    }).text(message));
            }

            var $pnlMessages = $("div#pnl-messages");
            var $tbChat = $("input#tb-chat");
            var $tbChatSession = $("input#tb-chat-session");
            var $btnChat = $("button#btn-chat");

            $pnlMessages.css('height', window.innerHeight - $("#header").height() - $("#footer").height() -
                220);

            // initial session
            var settings = {
                "async": true,
                "crossDomain": true,
                "url": "https://pvgm50898582a.dhcp.pvgl.sap.corp:9004/api/context",
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "cache-control": "no-cache",
                },
                "processData": false,
                "data": JSON.stringify({
                    "session": "default",
                    "uid": employee.id,
                    "content": "default"
                })
            };

            $.ajax(settings).done((res) => {
                let d = JSON.parse(res);
                console.log(d);
                if (d && d.state === 'success') {
                    // console.log('session', d.session)
                    $tbChatSession.val(d.session);

                    let firstName = employee.name.split(' ')[0];
                    let message = d.message.display.replace('[username]', firstName);
                    let initItem = createChatItem(message);

                    if (window.speechSynthesis) {
                        window.speechSynthesis.speak(new SpeechSynthesisUtterance(message));
                    }

                    $pnlMessages.append(initItem)
                        .animate({
                            scrollTop: $pnlMessages.prop("scrollHeight")
                        }, 500);
                }
            }).fail((res) => {
                alert(`${res.status} (${res.statusText})`);
            });

            // button binded
            $tbChat.on('keydown', (e) => {
                if (e.which == 13) {
                    if ($tbChat.val() != '') {
                        $btnChat.click();
                    }
                    return false;
                }
            });

            $btnChat.on('click', () => {
                if ($tbChat.val() == '') {
                    return false;
                }

                let item = createChatItem($tbChat.val(), user = employee.name, avatar = employee.image,
                    me = true);

                $pnlMessages.append(item).animate({
                    scrollTop: $pnlMessages.prop("scrollHeight")
                }, 500);


                settings.data = JSON.stringify({
                    "session": $tbChatSession.val(),
                    "uid": employee.id,
                    "content": $tbChat.val()
                })

                $.ajax(settings).done((res) => {
                    let d = JSON.parse(res);
                    console.log(d);

                    if (d && d.state === 'success') {
                        let item = createChatItem(d.message.display);
                        if (window.speechSynthesis) {
                            window.speechSynthesis.speak(
                                new SpeechSynthesisUtterance(d.message.display));
                        }
                        $pnlMessages.append(item).animate({
                            scrollTop: $pnlMessages.prop("scrollHeight")
                        }, 500);

                        // record time
                        if (d.step === 'DONE_MSG' && d.uid == employee.id) {
                            const settings_record = {
                                "async": true,
                                "crossDomain": false,
                                "url": "/api/sync/byd/record",
                                "method": "POST",
                                "headers": {
                                    "Content-Type": "application/json",
                                    "cache-control": "no-cache",
                                },
                                "processData": false,
                                "data": JSON.stringify({
                                    "employee": employee.eid,
                                    "datetime": new Date(d.para.datetime)
                                        .toLocaleDateString('zh-CN'),
                                    "duration": `PT${d.para.duration}H0M`
                                })
                            };

                            $.ajax(settings_record).done((res) => {
                                console.log(res);
                                if (res.d.results.LifeCycleStatusCode == 2) {
                                    console.log(employee.app, 'Recorded:', res.d.results.LifeCycleStatusCodeText, res.d.results.ApprovalStatusCodeText);
                                }

                            }).fail((res) => {
                                alert(`${res.status} (${res.statusText})`);
                            });
                        }
                    }

                    $tbChat.val('');
                }).fail((res) => {
                    alert(`${res.status} (${res.statusText})`);
                });
            });
        });
    </script>
</body>

</html>